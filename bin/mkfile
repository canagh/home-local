#!/bin/sh

templates_dir=${TEMPLATES_DIR:-$HOME/.templates}
name_type=random

while [ -n "$1" ] ; do
    case "$1" in
        -h | --help )
            echo `basename "$0"`' [OPTIONS..] TEMPLATE [FILENAMES..]'
            exit
            ;;
        -s | --same-name )
            name_type=same
            shift
            ;;
        -l | --list )
            ls -1 "$templates_dir"
            exit
            ;;
        -* )
            echo `basename "$0"`': unknown option: '\`"$1"\' 1>&2
            exit 1
            ;;
        * )
            break
            ;;
    esac
done

# find the template
for file in $(find "$templates_dir" -type f -name "$1") ; do
    if [ -n "$template" ] ; then
        echo `basename "$0"`': more than one templates found: '\`"$template"\'' and '\`"$1"\' 1>&2
        exit 1
    else
        template="$file"
    fi
done
if [ -z "$template" ] ; then
        echo `basename "$0"`': template not found' 1>&2
        exit 1
fi
shift

# copy the template
for i in ${@:-.} ; do
    if [ -f "$i" ] ; then
        echo 'mkfile: the file '\`"$i"\'' already exists' 1>&2
    elif [ -d "$i" ] ; then
        case $name_type in
            random )
                file="$(mktemp --tmpdir="$i" "$(basename $0)".XXXXXX)"
                ;;
            same )
                file="$i"/"$(basename "$template")"
                if [ -e "$file" ] ; then
                    echo 'mkfile: the file '\`"$i"\'' already exists' 1>&2
                    continue
                fi
                ;;
        esac
        cat "$template" >"$file"
    else
        cp "$template" "$i"
    fi
done
