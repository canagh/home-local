#!/bin/bash

format='%l <bold>%n</bold> <mail>%M</mail> %d %t %i %b<br>%m<br>'
regexp="`cat <<'EOS'
s!\(>>[[:digit:]]\+\)!<blue>\1</blue>!g ;
s!\(h\?ttps\?://[^[:space:]]\+\)!<underscore>\1</underscore>!g ;
s!<\(/\?\)b>!<\1bold>!ig ;
s!<mail>sage</mail>!<blue>[sage]</blue>! ;
s!<mail>\(.*\)</mail>!<red>[\1]</red>! ;
EOS
`"
nodownload=
reload=
tdiff=3

args=()
while [ "$1" ] ; do
    case "$1" in
        -h | --help )
            echo `basename "$0"`': [-r|--reload] [-n|--no-download] [-f|--format FORMAT] [-e|--regexp EXPR] [--regexp-clear]TARGET'
            exit
            ;;
        -r | --reload )
            [ "$nodownload" ] && echo `basename "$0"`': -r(--reload) option conflicts with -n(--no-download)' 1>&2 && exit 1
            reload=t
            shift
            ;;
        -n | --no-download )
            [ "$reload" ] && echo `basename "$0"`': -n(--no-download) option conflicts with -r(--reload)' 1>&2 && exit 1
            nodownload=t
            shift
            ;;
        -f | --format )
            format="$2"
            shift 2
            ;;
        -e | --regexp )
            regexp="$regexp"\;"$2"
            shift 2
            ;;
        -d | --time-difference )
            tdiff="$2"
            shift 2
            ;;
        --regexp-clear )
            regexp=''
            shift
            ;;
        -- )
            shift
            args=("${args[@]}" "$@")
            break
            ;;
        -* )
            echo `basename "$0"`': unknown option: '\`"$1"\' 1>&2
            exit 1
            ;;
        * )
            args=("${args[@]}" "$1")
            shift
            ;;
    esac
done

path=$(2ch-get --print-path "${args[@]}")
last_line=1
[ -f "$path" ] && last_line=`wc -l < "$path"`
if [ "$nodownload" ]; then
    :
elif [ -n "$reload" -o ! -f "$path" ]; then
    2ch-get -r -- "${args[@]}" >/dev/null
else
    find "$path" -mmin +"$tdiff" -exec 2ch-get -- "${args[@]}" \; >/dev/null
fi

cat "$path" | 2ch-utils decode | 2ch-format -f "$format" | 2ch-utils rmanchor stripbreak unescapegt | sed -e "$regexp" | colorml --html | less '+/^'"$last_line"' '
