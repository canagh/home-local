#!/usr/bin/env python

import argparse

parser = argparse.ArgumentParser(description='TODO: allow a format like `chext * -m cxx cpp\'')
parser.add_argument('files', metavar='FILE', nargs='+')
parser.add_argument('ext', metavar='EXT')
parser.add_argument('-s', '--simulate', action='store_true')
parser.add_argument('-m', '--match')
parser.add_argument('-a', '--all', action='store_true', help='use all extension, like `.tar.gz\' of `foo.tar.gz\'')
parser.add_argument('-p', '--put', action='store_true', help='don\'t ignore no-extension files')
args = parser.parse_args()

import os

def splitextall(path):
    root, ext = os.path.splitext(path)
    if path == root and ext == '':
        return root, ext
    else:
        nroot, next = splitextall(root)
        return nroot, next + ext

splitext = os.path.splitext
if args.all:
    splitext = splitextall

for file in args.files:
    dir, base = os.path.split(file)
    root, ext = splitext(base)
    if args.match is not None:
        if ext != '.' + args.match:
            continue
    if not args.put:
        if ext == '':
            continue
    new = root + '.' + args.ext
    if args.simulate:
        print('in `' + dir + "': rename `" + base + "' `" + new + "'")
    else:
        os.rename(file, os.path.join(dir, new))
