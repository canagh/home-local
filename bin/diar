#!/usr/bin/python3

import argparse

parser = argparse.ArgumentParser()
# root dir
parser.add_argument('-d', '--date', metavar='DATE')
# target file
parser.add_argument('-f', '--file', metavar='FILE', default='diary.md')
parser.add_argument('--diary',
        action='store_const', const='diary.md', dest='file')
# action
parser.add_argument('-e', '--edit',
        action='store_const', const='edit', dest='action', default='edit')
parser.add_argument('-p', '--print',
        action='store_const', const='print', dest='action')
args = parser.parse_args()

import datetime
if args.date is None:
    args.date = datetime.date.today()
else:
    days = {}
    days['today'] = datetime.date.today()
    days['yesterday']  = days['today'] + datetime.timedelta(days=-1)
    days['2 days ago'] = days['today'] + datetime.timedelta(days=-2)
    days['3 days ago'] = days['today'] + datetime.timedelta(days=-3)
    days['tommorow']   = days['today'] + datetime.timedelta(days=+1)
    if days.get(args.date) is not None:
        args.date = days.get(args.date)
    else:
        import dateutil.parser
        args.date = dateutil.parser.parse(args.date)

import os
def root_path():
    return os.environ.get('DIAR_DIR', os.environ['HOME'] + '/.dair')
def day_path(date):
    return root_path() + date.strftime('/%Y/%m/%d')
def edit_file(path, dir=False):
    editor = os.environ.get('VISUAL', os.environ['EDITOR'])
    dirname = path if dir else os.path.dirname(path)
    if not os.path.exists(dirname):
        os.makedirs(dirname)
    import subprocess
    subprocess.call([editor, path])

target_path = day_path(args.date) + ('/' + args.file if args.file else '')
actions = {}
actions['edit'] = lambda : edit_file(target_path, dir=(args.file == ''))
actions['print'] = lambda : print(target_path)
actions[args.action]()
