#!/bin/sh

compiler=g++
source=

while [ "$1" ] ; do
    case "$1" in
        -h | --help )
            echo `basename "$0"`' [-s|--source PATH] [-c|--compiler PATH (default: '"$compiler"')] -- [COMPILER_OPTIONS..]'
            echo 'Compile a code and execute it without makeing any files.'
            exit
            ;;
        -s | --source )
            source=`realpath "$2"`
            shift 2
            ;;
        -c | --compiler )
            compiler="$2"
            shift 2
            ;;
        -- )
            shift
            break
            ;;
        -* )
            echo `basename "$0"`': unknown option: '\`"$1"\' 1>&2
            exit 1
            ;;
        * )
            break
            ;;
    esac
done

TEMPDIR=`mktemp -d` || exit 1
trap "rm -rf -- '$TEMPDIR'" EXIT
cd $TEMPDIR

if [ ! "$source" ]; then
    source=`basename "$0"`.cpp
    if [ -t 0 ]; then
        $EDITOR $source || exit 1
    else
        cat >> $source
    fi
fi
"$compiler" "$@" "$source" && ./a.out

rm -rf -- "$TEMPDIR"
trap - EXIT
exit
