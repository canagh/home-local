#!/bin/sh

charlist=
length=
need=
while [ "$1" ]; do
    case "$1" in
        -h | --help )
            echo 'Usage: echo LONG_LONG_STRING | '`basename "$0"`' [OPTIONS..]'
            echo 'My own tool to make a passward from long char-list.'
            echo
            echo "ex. $ echo '1234hoge56&*()ABCD' | passconv -c '[:alpha:][:digit:]' -l 4 -n '[:upper:]'"
            echo e56A
            exit
            ;;
        -c | --char-list )
            charlist="$2"
            shift 2
            ;;
        -l | --length )
            length="$2"
            shift 2
            ;;
        -n | --need )
            need="$2"
            shift 2
            ;;
        -* )
            echo `basename "$0"`': unknown option: '\`"$1"\' 1>&2
            exit 1
            ;;
        * )
            break
            ;;
    esac
done

if [ -z "$charlist" -o -z "$length" -o $# -ne 0 ]; then
    echo `basename "$0"`': invalid options' 1>&2
    exit 1
fi

tails() {
    str=`head -c "$length"`
    [ `echo -n "$str" | wc -m` -eq "$length" ] || exit 1
    while true; do
        echo "$str"
        chr=`head -c 1`
        [ "$chr" ] || exit 1
        str="$str""$chr"
        str="`echo -n "$str" | tail -c "$length"`"
    done
}

checkloop() {
    while read line; do
        if pred "$line"; then
            echo "$line"
            exit
        fi
    done
    exit 1
}

pred() {
    echo -n "$1" | grep \["$need"\] >/dev/null 2>&1
}

sed -e 's/[^'"$charlist"']//g' | tails | checkloop
